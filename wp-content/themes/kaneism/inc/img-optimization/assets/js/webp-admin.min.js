!function($){"use strict";let isProcessing=!1,isPaused=!1,originalPageTitle=document.title,retryCount=0,maxRetries=3,processingDelay=500;const $startButton=$("#start-processing"),$pauseButton=$("#pause-processing"),$resumeButton=$("#resume-processing"),$progressBar=$(".progress"),$progressText=$(".progress-text"),$currentProcessing=$("#current-processing"),$currentImageName=$("#current-image-name"),$logEntries=$("#log-entries");function showNotification(title,message){if("Notification"in window&&"granted"===Notification.permission){const notification=new Notification(title,{body:message,icon:"/wp-includes/images/w-logo-blue.png"});setTimeout((()=>{notification.close()}),5e3)}}function startProcessing(){isProcessing=!0,isPaused=!1,retryCount=0,$startButton.hide(),$pauseButton.show(),$resumeButton.hide(),$currentProcessing.show(),$logEntries.empty(),processNextImage(),saveState()}function pauseProcessing(){isPaused=!0,$pauseButton.hide(),$resumeButton.show(),addLogEntry("Conversion paused by user.","paused"),document.title="⏸ "+originalPageTitle,saveState()}function resumeProcessing(){isPaused=!1,isProcessing=!0,retryCount=0,$startButton.hide(),$resumeButton.hide(),$pauseButton.show(),$currentProcessing.show(),addLogEntry("Conversion resumed.","info"),processNextImage(),saveState()}function processNextImage(){if(!isProcessing||isPaused)return;retryCount=0,$currentImageName.text("Loading next image...");const startTime=(new Date).getTime();$.ajax({url:kaneismWebp.ajaxUrl,type:"POST",dataType:"json",data:{action:"kaneism_webp_process_single",nonce:kaneismWebp.nonce},success:function(response){var data;response.success?function(data,startTime){if("complete"===data.status)return isProcessing=!1,$currentProcessing.hide(),$pauseButton.hide(),$resumeButton.hide(),updateProgress(data.progress),addLogEntry("WebP conversion complete! All images have been processed.","success"),showNotification("WebP Conversion Complete","All images have been processed successfully!"),document.title="✓ "+originalPageTitle,void localStorage.removeItem("kaneismWebpState");const image=data.image;if($currentImageName.text(image.filename),image.success){let sizeInfo="";image.details&&image.details.original&&(sizeInfo=" ("+image.details.original.reduction+" reduction)"),addLogEntry("Converted: "+image.filename+sizeInfo,"success"),image.details&&image.details.sizes_converted&&addLogEntry("Size variants: "+image.details.sizes_converted,"info")}else addLogEntry("Failed to convert: "+image.filename+" - "+image.message,"error");if(updateProgress(data.progress),isProcessing&&!isPaused){const delay=function(startTime){const processingTime=(new Date).getTime()-startTime;return processingTime>2e3?processingDelay=Math.min(2e3,processingDelay+100):processingTime<500&&processingDelay>500&&(processingDelay=Math.max(500,processingDelay-50)),processingDelay}(startTime);setTimeout(processNextImage,delay)}saveState()}(response.data,startTime):(addLogEntry("Error: "+((data=response.data).message||"Unknown error occurred"),"error"),pauseProcessing(),showNotification("WebP Conversion Error",data.message||"An error occurred during conversion."))},error:function(xhr,status,error){if(retryCount<maxRetries){retryCount++;const retryDelay=2e3*retryCount;addLogEntry("Server error occurred. Retrying in "+retryDelay/1e3+" seconds... (Attempt "+retryCount+"/"+maxRetries+")","warning"),$currentImageName.text("Retry in "+retryDelay/1e3+"s..."),setTimeout(processNextImage,retryDelay)}else{const errorMessage=xhr.responseJSON&&xhr.responseJSON.message?xhr.responseJSON.message:"Error: "+status+(error?" - "+error:"");addLogEntry("Server error occurred after "+maxRetries+" attempts. Please try again. "+errorMessage,"error"),$currentImageName.text("Error occurred"),pauseProcessing(),showNotification("WebP Conversion Error","An error occurred during conversion. Process has been paused.")}},timeout:6e4})}function updateProgress(progress){const total=progress.total_images||0,processed=progress.processed_images||0;if(total>0){const percentage=processed/total*100,roundedPercentage=Math.round(10*percentage)/10;$progressBar.css("width",percentage+"%"),$progressText.html("<strong>Progress:</strong> "+processed+" of "+total+" images processed ("+roundedPercentage+"%)"),isProcessing&&!isPaused&&(document.title="("+Math.round(percentage)+"%) "+originalPageTitle)}}function addLogEntry(message,type){const timestamp=(new Date).toLocaleTimeString();let icon="•";switch(type){case"success":icon="✓";break;case"error":case"warning":icon="⚠";break;case"paused":icon="⏸";break;case"info":icon="ℹ"}const $entry=$("<li>").addClass("log-entry log-"+type).html('<span class="log-time">['+timestamp+']</span> <span class="log-icon">'+icon+"</span> "+message);$logEntries.prepend($entry);$("#processing-log").scrollTop(0)}function saveState(){const state={isProcessing:isProcessing,isPaused:isPaused,timestamp:(new Date).getTime()};localStorage.setItem("kaneismWebpState",JSON.stringify(state))}$(document).ready((function(){$startButton.on("click",startProcessing),$pauseButton.on("click",pauseProcessing),$resumeButton.on("click",resumeProcessing),$("#webp-conversion-form").on("submit",(function(){return confirm("Are you sure you want to start a new conversion process? This might take some time depending on the number of images in your Media Library.")})),function(){const savedState=function(){const stateJson=localStorage.getItem("kaneismWebpState");if(stateJson)try{const state=JSON.parse(stateJson),currentTime=(new Date).getTime();if(currentTime-(state.timestamp||0)<36e5)return state}catch(e){}return null}();savedState&&savedState.isProcessing&&!savedState.isPaused&&setTimeout((function(){confirm(kaneismWebp.strings.resume||"Resume the WebP conversion that was in progress?")&&resumeProcessing()}),1e3)}(),$(window).on("beforeunload",saveState),"Notification"in window&&"denied"!==Notification.permission&&Notification.requestPermission(),originalPageTitle=document.title}))}(jQuery);